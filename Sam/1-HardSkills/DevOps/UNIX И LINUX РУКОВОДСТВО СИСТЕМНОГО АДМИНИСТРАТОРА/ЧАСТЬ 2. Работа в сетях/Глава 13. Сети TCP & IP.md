# Глава 13. Сети TCP & IP
TCP/IP (Transmission Control Protocol/lnternet Protocol) - это сетевая система, лежащая в основе Интернета. Она не зависит ни от аппаратного обеспечения, ни от операционной системы , поэтому все устройства, использующие протокол ы TCP/IP, могут обмениваться данными (" взаимодействовать" ), несмотря на различия. 

## 13.1. СИСТЕМА TCP/IP и ИНТЕРНЕТ
Прародительницей Интернета была сеть ARPANEТ, организованная в 1969 году Министерством обороны США.

Основными действующими лицами в управлении Интернетом являются следующие организации. 
- ICANN
- ISOC
- IGF

### Сетевые стандарты и документация
RFC - документация Интернета

## 13.2. Основы работы в сети
**TCP/IP** - это семейство сетевых протоколов, ориентированных на совместную работу. В состав семейства входит несколько компонентов:
- **IP** (**Internet Protocol** - межсетевой протокол) обеспечивает передачу пакетов данных с одного компьютера на другой (RFC791) 
- **ICMP** (**Internet Control Message Protocol** - протокол управляющих сообщений в Интернете) отвечает за различные виды низкоуровневой поддержки протокола IP, включая сообщения об ошибках, вспомогательные маршрутизирующие запросы и отладочные сообщения (RFC792)
- **ARP** (**Address Resolution Protocol** - протокол преобразования адресов) обеспечивает трансляцию IP-адресов в аппаратные адреса (RFC826)
- **UDP** (**User Datagram Protocol** - протокол передачи датаграм пользователя) обеспечивает непроверяемую односторонюю доставку данных (RFC768)
- **TCP** (**Transmission Control Protocol** - протокол правления передачей) обеспечивает надёжный дуплексный канал для связи между процессами на двух компьтерах с возможностью управления потоками и контроля ошибок (RFC793)
![[Pasted image 20221014170303.png|600]]

### Версии IPv4  и IPv6
В новой версии всё лучше с безопасностью и с размером адресного простанства. 
Протокол **NAT** (**Network Address Translation** - трансляция сетевых адресов, см. раздел 13 .4) позволяет целым сетям машин скрываться за одним адресом  IPv4.

Технология **CIDR** (**Classless lnter-Domain Routing** бесклассовая междомен ная маршрутизация , см . раздел 1 3 .4) гибко разделяет сети и способствует эффективной магистральной маршрутизации.

### Пакеты и их инкапсуляция
TCP/IP поддерживает целый ряд физических сетей. Управление аппаратными устройствами осуществляется на канальном уровне архитектуры TCP/IP.

Данные передаются по сети в виде пакетов имеющих заголовок с метаданными и полезное содержимое.

Название базового блока передачи разные на разных уровнях, но мы будем назвать - пакет.

Готовящийся к отправке пакет передается вниз по стеку протоколов, и каждый протокол добавляет в него собственный заголовок. Сформированный пакет одного протокола становится полезным содержимым пакета, генерируемого следующим протоколом. Эта операция называется инкапсуляцией . На принимающей стороне инкапсулированные пакеты восстанавливаются в обратном порядке при прохожден и и вверх по стеку.
![[Pasted image 20221014171907.png]]

### Стандарты формирования фреймов Ethernet
На самом деле канальный урове н ь разделен на две части: МАС ( подуровень Media Access Control ) и LLC ( подуровень Link Layer Control). Подуровень МАС работает с аудиовизуальной информацией и передает пакеты по проводам. Подуровен ь LLC формирует фреймы. В настоящее время существует единственный стандарт формирован ия фреймов по технологии Ethernet: DIX Ethernet 1 1 . Кроме того, по историческим причинам используется еще несколько стандартов, основанных на стандарте I EE E 802.2, особенно в сетях Novell.

#### Максимальный разм ер пере даваемого блока
![[Pasted image 20221014175414.png|500]]

Размер сетевых пакетов ограничивается как характеристи кам и аппаратных средств, так и требованиями протоколов. Например, объем полезного содержимого стандартного Ethernet-фpeймa не может превышать 1 500 байт. Предельный размер пакета устанавливается на канальном уровне и называется максимальной единицей передачи (Maximum Transfer Unit - MTU). Стандартн ые значения параметра MTU для разных видов сете й приведены в табл. 13.1.

## 13.3 Адресация пакетов
В с истеме TC P/I P исполь­
зуется сочетан ие нескол ьких схем адресации .
- Адреса МАС (media access control) для использования в сетевом оборудовании.
- Сетевые адреса протоколов IPv4 и IPv6 для использования в программном обеспечении.
- Имена компьютеров для использования пользователями.

### Аппаратная адресация (МАС)
Каждый сетевой интерфейс имеет свой MAC-адрес канального уровня, который отличает его от других компьютеров в физической сети, а так же один или несколько IP-адресов, идентифицирующих интерфейс в глобальной сети Интернета.

### IP-адресация
Не всегда один IP-адрес относится к одному интерфейсу, а сразу к нескольким, через NAT протокол.

Соответствие между IР-адресами и аппаратными адресам и устанавливается на канальном уровне модели ТСР/IР.

Соответствие между IР-адресами и аппаратными адресами устанавливается на канальном уровне модели **ТСР/IР**. В сетях, поддерживающих широковешательный режим (т.е. в сетях, позволяющих адресовать пакеты "всем компьютерам данного физического сегмента" ), протокол **ARP** обеспечи вает автоматическую привязку адресов без вмешательства системного администратора. В протоколе IPv6 МАС-адреса интерфейсов можно использовать как часть IР-адресов, благодаря чему преобразование IР-адресов в аппаратные адреса становится практически автоматическим.

### "Адресация" имен машин
Поскольку IР-адреса представляют собой длинные числа, запоминать их трудно. Операционные системы позволяют закреплять за IР-адресом одно или несколько текстовых имен, чтобы вместо 4.31.198.49 пользователь мог ввести rfc-editor.org. В системах UNIX и Linux это отображение можно осуществить с помощью статического файла (/etc/hosts), базыданных LDAP и, наконец, DNS ( Domain Name System) - глобальной системы доменных имен. Следует помнить о том , что имя компьютера это лишь сокращенный способ записи IР-адреса, и он относится к сетевому интерфейсу, а не компьютеру.

### Порты
IP-адреса идентифицируют сетевые интерфейсы компьютера, но они недостаточно конкретны для идентификации отдельных процессов и служб. Протоколы ТСР и UDP расширяют концепцию IР-адресов, вводя понятие порта. Порт представляет собой 16-разрядное число, добавляемое к IР-адресу и указывающее конкретный канал взаимодействия. Его значение варьируется в диапазоне от 1 до 65535.

Стандартные службы, такие как SMTP, SSH и НТТР, ассоциируются с хорошо известными портами, определенными в файле */etc/services*

Файл *services* является частью инфраструктуры.

### Типы адресов
- Направленные (unicast) - адреса, которые обозначают отдельный сетевой интерфейс.
- Групповые (multicast) - адреса, идентифицирующие группу хостов.
- Широковещательные (broadcast) - адреса, обозначающие все хосты локальной сети.
- Альтернативные (anycast) - адреса, обозначающие любой из группы хостов.

## 13.4. IP-адреса
За исключением групповых адресов, адреса И нтернета состоят из двух частей: сетевой и машинной . Сетевая часть идентифицирует логическую сеть, к которой относится адрес, а машинная - хост этой сети. В протоколе IPv4 адреса состоят из четырех байтов, а граница между сетевой и машинной частям и устанавливается административно. В протоколе IPv6 адреса состоят из 16 байт, а сетевая и машинная части всегда состоят из 8 байт.

### Классы адресов в протоколе IPv4
Классы А, В и С обозначают обычные IР-адреса, а классы D и Е применяются при групповой адресации и в исследовательских целях. В табл . 13.2 представлены характеристики каждого класса адресов. Сетевая часть адреса помечена буквой С, а машинная - буквой М .

![[Pasted image 20221015011442.png|550]]

### Подсети IPv4
Маски nодсети , как и любой сетевой интерфейс, задаются с помощью команд `ip` или `ifconfig`. По умолчанию эти ко манды исnользуют класс адреса для того, чтобы выяснить, какие биты относятся к сетевой части . Если задается явная маска, то эта функция просто отменяется.

### Трюки и инструменты для арифметических вычислений, связанных с подсетями
Манипул ировать всем и этим и битами в у м е трудно, но есть ряд приемов, позволяющих упростить вычисления. Число хостов в сети и значение последнего байта сетевой маски в сумме все гда дают 256.

*(последний байт сетевой маски) = 256 - (размер сети)*

Так, в рассмотренном выше случае формула даст результат 256-64=192, где 192-последний байт маски. 

Другое правило гласит о том , что значение последнего байта фактического адреса сети (не сетевой маски) должно нацело делиться на число хостов сети. В рассматриваемом примере последние байты равны О, 64, 128 и 192 - каждое из этих чисел делится нацело на 64. 5 И ме я только I Р-адрес (допустим , 128.138.243.100) , невозможно сказать, каким будет адрес сети и широковещательный адрес. В табл. 13.3 представлены возможные варианты для масок /16 (выбирается по умолчанию для адресов класса В ), /24 и /26 (наиболее приемлемая длина, если имеющееся адресное пространство невелико).
![[Pasted image 20221015013339.png|600]]

```
> ipcalc [ip/mask]
```

### CIDR: протокол бесклассовой междоменной маршрутизации
Как и подсети, прямым расширением которых он я вляется, протокол CIDR основан на использовании явной маски подсети, определяющей границу между сетевой и машинной частям и адреса. Но, в отличие от подсетей, протокол CIDR допускает, чтобы сетевая часть была меньше, чем того требует класс адреса. Благодаря укороченной маске возникает эффект объединения нескол ьких сетей для облегчения маршрутизации . По этой причине протокол CIDR иногда называют протоколом *формирования суперсетей*.

Врутри сети могут быть подсети с другими масками. Но в одной сети должна быть одна маска.

### Выделение адресов
![[Pasted image 20221015015113.png|600]]

### Частные адреса и система NAT
![[Pasted image 20221015015249.png|600]]
Для того чтобы хосты, использующие частн ы е адреса, могл и получать доступ в Интернет, на пограничном маршрутизаторе организации должна выполняться с истема NAT (Network Address Translation - трансляция сетевых адресов) . Эта система перех ватывает пакеты и заменяет в них адрес отправителя реальным внешним IР-адресом. Может также происходить замена номера исходного порта. Система хранит таблицу преобразований между внутренними и внешними адресам и/портами, чтобы ответные пакеты доставлялись нужному адресату.

### Адресация в стандарте IPvб
Адреса IPv6 имеют длину 128 бит.

### Нотация адресов IРv6
Стандартная нотация адресов 1 Pv6 делит 1 28 бит адреса на 8 групп по 16 бит каждый , разделенных двоеточиями. Например,
2 6 0 7 : f 8 b 0 : 0 0 0 a : 0 8 0 6 : 0 0 0 0 : 0 0 0 0 : 0 0 0 0 : 2 0 0 e

### Префиксы IРv6
...

## 13.5. Маршрутизация
Маршрутная информация в системе TCP/ IP имеет форму правил (маршрутов) , например: "Для того чтобы достичь сети А, посылайте пакеты через компьютер С". Часто существует и стандартн ы й маршрут. В нем объясняется , что нужно делать с пакетами, предназначенными для отправки в сеть, маршрут к которой не указан явным образом.

Данные маршрутизации хранятся в одной из таблиц ядра. Каждый элемент этой таблицы содержит нескол ько параметров , включая сетевую маску. Для направления пакета по заданному адресу ядро подбирает наиболее конкретный маршрут (т.е . тот, где самая длинная маска). Если ни один из маршрутов (в том числе стандартный) не подходит, то отправителю возвращается IСМР-сообщение вида "network unreachаble " (сеть недоступна).

Слово "маршрутизация" широко употребляется в двух различных смыслах:
- процедура поиска сетевого адреса в специальной таблице для передачи пакета в пункт е го назначения 
- процесс построения этой таблицы.

### Таблицы маршрутизации
Таблицу маршрутизации можно просмотреть с помощью команды `ip route show` в системе Linux или `netstat - r` в системе FreeBSD.

Команда `netstat -rn` запрещает поиск доменных имен в системе DNS и выводит всю и нформацию в числовом виде, что в принципе полезнее.

- `ip r`
- `netstat -rn`
- `route` 

**Инициализация таблицы маршрутизации**
```bash
> ip route flush
```

**Добавление записи в таблицу маршрутизации**
```bash
> ip route add (dest) via (via) dev (interface)

> ip route add 123.23.23.21/26 via 122.23.123.3 dev eth1
> ip route add default via 122.23.123.3 dev eth0
```

**Удаление записи в таблицу маршрутизации**
```bash
> ip route delete
```

**Преобразование имён в сетевые адреса**
Сетевые имена можно также получить из баз данных NIS или DNS (см. документ RFC1101).
```bash
> vim /etc/hosts
> vim /etc/networks
```

Большинство компьютеров локальной сети имеет единственный выход во внешний мир, поэтому маршрутизация осуществляется очень просто: достаточно на этапе начальной загрузки добавить стандартный маршрут. Компьютер может получить стандартный маршрут в месте со своим IР-адресом у сервера DHCP (этот протокол описан в разделе 13.7).

## 13.6. ARP: Протокол преодбразования адресов в IPv4 и IPv6
Несмотря на то что IР-адреса являются аппаратно-независимыми, для фактической передачи данных на канальном уровне должны применяться аппаратные адреса. В протоколах IPv4 и IPv6 используются разные протоколы, которые практически одинаковым образом определяют, какой аппаратный адрес связан с тем или иным
IР-адресом .
В системе Linux команда `ip neigh` изучает и обрабатывает содержимое кеша ARP или ND.

## 13.7. DHCP: Протокол динамического конфигурирования хостов
Когда вы добавляете устройство или компьютер в сеть, то обычно получаете свой IР-адрес в локальной сети, настраиваете соответствующий маршрутизатор , заданный по умолчанию, и присоединяетесь к локальному серверу DNS. Все это за вас может сделать протокол **DHCP** (**Dynamic Host Configuration Protocol** - протокол динамического конфигурирования хостов).

### Программное обеспечение DHCP
...

## 13.9. Основы конфигурирования сети
Чтобы не усложнять себе жизнь, указывайте в конфигурационных файлах сетевые имена, а привязки к IР-адресам храните только в базе данных DNS и файлах конфигурации DHCP.
Использование файла `/etc/hosts` - старейший и простейший способ преобразования сетевых имен в I Р-адреса. Каждая строка файла начинается с IР-адреса и содержит различные символьные имена, под которыми известен адрес.

Команда `hostname` назначает компьютеру сетевое имя.

### Настройк а сетевых интерфейсов и протокола IP
Сетевой интерфейс - это часть оборудования, которое потенциально может быть подключено к сети.

В большинстве с истем вы можете увидеть все сетевые интерфейсы с помощью команд `ip link show` (Linux) или `ifconfig -a` (FreeBSD) , независимо от того , были ли настроены или запущены интерфейсы.
```bash 
> ip link show
> ip l
> diff <(ls old) <(ls new)
```

### Настройка маршрутизации
Но есть два особы х случая . Во-первых, пакет может быть адресован ком пьютеру, включенному в ту же сеть, что и хост-отправител ь. В этом случае адрес следуюшего шлюза соответствует одному из и нтерфейсов локал ьного компьютера, и пакет посылается прямо получателю. Маршруты такого типа добавляются командами `ifconfig` и `ip address`при конфигурировании интерфейса

### Конфигурирование DNS
Для того чтобы сконфигурировать компьютер в качестве DNS-клиента, достаточно отредактировать файл `/etc/resolv.conf`. DNS-служба при этом, строго говоря, не нужна, но трудно представить себе ситуацию, в которой без нее можно было бы вообще обойтись. Файл `resolv.conf` содержит список DNS-доменов, просматриваемых при анализе неполных имен, и список IР-адресов серверов имен, в которых осуществляется поиск имен.


## 13.10. Сетевое конфигурирование в системе Linux 
После внесения любых изменений в файл, управляющий сетевой конфигурацией в момент загрузки, необходимо либо перезагрузить систему, либо отключить сетевой интерфейс , а затем снова включить его, чтобы изменения вступили в силу. В большинстве систем Linux для этой цели можно использовать команды `ifdown` интерфейс или `ifup` интерфейс, хотя их реализации не являются идентичными.

### Программа NetworkManager
Программа NetworkManager в основном используется в ноутбуках, поскольку их сетевое окружение может часто изменяться.

Для серверов и настольных систем программа NetworkManager не обязательна и фактически может даже усложнять администрирование. В этом окружении она должна игнорироваться или отключаться.

### Команда `ip`: ручное конфигурирование сети
В прошлом системы Linux и UNIX использовали одни и те же основные команды для настройки сети и проверки состояния: `ifconfig`, `route` и `netstat`. Они попрежнему доступны в большинстве дистрибутивов, но активная разработка перешла к пакету `iproute2` , который содержит команды `ip` (для большинства повседневных сетевых конфигураций, включая маршрутизацию) и `ss` (приблизительный аналог команды `netstat` для изучения состояния сетевых сокетов).
```bash
> ip [option] object
```
`object`:
- `link` - для настройки сетевых интерфейсов.
- `address` - для привязки сетевых адресов к интерфейсам.
- `route` - для изменения или печати таблицы маршрутизации
Они могут принимать команды:
- `list`
- `show`

### Сетевое конфигурирование в системе Ubuntu
Как показано в табл . 13.6, система Ubuntu задает конфигурацию сети в файлах `/etc/hostname/`и `/etc/network/interfaces`, а справочная информация записана в файле `/etc/network/options`
![[Pasted image 20221015152157.png]]


## 13.12. Сетевые проблемы
- `ping [-n] google.com` -
- `ping -s 1500 google.com` - 1500 byte
- `traceroute` - трассировка IP-пакетов

#### Пакетные анализаторы трафика (sniffers)
- `tcpdump` 
- *Wireshark*

### Утилита tcpdump: пакетный анализатор трафика из командной строки
Утилита `tcpdump` уже давно является стандартным анализатором трафика, а большинство других инструментов анализа сети считывают и записывают файлы трассировки в формате `tcpdump`, также известном как формат `libpcap`.
```bash
tcpdump [-i | -n] host [ip-adress]
```

### Wireshark и TShark: улучшенные варианты tcpdump
...

## 13.13. Мониторинг сети
...